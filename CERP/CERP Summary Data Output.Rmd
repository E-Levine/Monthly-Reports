---
title: "Summary Data Output"
author: "ELevine"
date: "2024-06-26"
output: 
  html_document:
  word_document: null
  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

Author <- c("E Levine") #Change to your name
Database <- "Oysters_24-07-01"  #Set the local database to use
Server = "localhost\\ERICALOCALSQL" #Set the local Server to use

Start_date <- as.Date("2022-01-01")
End_date <- as.Date("2022-06-30")

#Packages
if (!require("pacman")) {install.packages("pacman")}
pacman::p_load(odbc, DBI, dbplyr,
  tidyverse, dplyr,  stringr, #DF manipulation
  DT, openxlsx,         #Excel
  lubridate, zoo,         #Dates
  knitr, 
  install = TRUE)

Estuaries <- c("SL", "LX", "CR", "LW")
Sites <- c("CR-E", "CR-W", "LW-L", "LW-R", "LX-N", "LX-S", "SL-C", "SL-N", "SL-S")
LocationID_order <- c("0230", "0231", "0232", "0233",  #CR
                      "0235", "0236", "0237", "0240", "0241", "0312", #LW
                      "0242", "0243", "0244", "0246", "0247", "0249", #LX
                      "0255", "0256", "0257", "0261", "0262", "0264", "0269", "0270", "0271") #SL
Station_order <- c("CR-E1", "CR-E2", "CR-W3", "CR-W4", #CR
                   "LW-L1", "LW-L2", "LW-L3", "LW-R2", "LW-R3", "LW-R4", #LW
                   "LX-N1", "LX-N2", "LX-N3", "LX-S1", "LX-S2", "LX-S3", #LX
                   "SL-C1", "SL-C2", "SL-C3", "SL-N1", "SL-N2", "SL-N3", "SL-S1", "SL-S2", "SL-S3") #SL
Date_exclusion <- c("CR-W4_RetDate", "CR-E2_RetDate", "LW-L2_RetDate", "LW-L3_RetDate", "LW-R3_RetDate", "LW-R4_RetDate", "LX-N2_RetDate", "LX-N3_RetDate", "LX-S2_RetDate", "LX-S3_RetDate", "SL-C2_RetDate", "SL-C3_RetDate", "SL-N2_RetDate", "SL-N3_RetDate", "SL-S2_RetDate", "SL-S3_RetDate")

Append_new_data <- c("Repro") #Y (All), N (None), WQ (just WQ), Dermo (just Dermo), Rcrt (just Recruitment)

```

```{css}
caption {
  color: black;
  font-weight: bold;
  font-size: 14;
} 
```

```{r DatabaseDownload}
# Connect to Local database server and pull all necessary data, then close connection 
con <- dbConnect(odbc(),
                    Driver = "SQL Server", 
                    Server = Server,
                    Database = Database,
                    Authentication = "ActiveDirectoryIntegrated")

dboFixedLocations <- tbl(con,in_schema("dbo", "FixedLocations")) %>%
  collect() %>% 
  filter(Estuary %in% Estuaries & grepl("^0", FixedLocationID)) %>% #Limit to primary stations, remove "ARRA" and SLN4
  filter(!grepl("^ARRA", StationName) & StationName != "SL-N-4")
#Water quality
hsdbSampleEventWQ <- tbl(con,in_schema("hsdb", "SampleEventWQ")) %>%
  collect() %>% mutate(FixedLocationID = substring(SampleEventID, 19, 22)) %>% #Create FixedLocationID column and filter to matching IDs
  filter(FixedLocationID %in% dboFixedLocations$FixedLocationID & str_detect(SampleEventWQID, 'RCRT')) #Limit to COLL (dermo) data (Pre-2023, WQ is with RCRT. 2023+ is with COLL)
dboSampleEventWQ <- tbl(con,in_schema("dbo", "SampleEventWQ")) %>%
  collect() %>% mutate(FixedLocationID = substring(SampleEventID, 19, 22)) %>% #Create FixedLocationID column and filter to matching IDs
  filter(FixedLocationID %in% dboFixedLocations$FixedLocationID & str_detect(SampleEventWQID, 'COLL')) #Limit to COLL (dermo) data
#Dermo
hsdbDermo <- tbl(con,in_schema("hsdb", "Dermo")) %>%
  collect() %>% mutate(FixedLocationID = substring(SampleEventID, 19, 22)) %>% #Create FixedLocationID column and filter to matching IDs
  filter(FixedLocationID %in% dboFixedLocations$FixedLocationID)
dboDermo <- tbl(con,in_schema("dbo", "Dermo")) %>%
  collect() %>% mutate(FixedLocationID = substring(SampleEventID, 19, 22)) %>% #Create FixedLocationID column and filter to matching IDs
  filter(FixedLocationID %in% dboFixedLocations$FixedLocationID)
#Cage
#Recruitment
hsdbRcrt <- tbl(con,in_schema("hsdb", "Recruitment")) %>%
  collect() %>% mutate(FixedLocationID = substring(SampleEventID, 19, 22)) %>% #Create FixedLocationID column and filter to matching IDs
  filter(FixedLocationID %in% dboFixedLocations$FixedLocationID)
dboRcrt <- tbl(con,in_schema("dbo", "Recruitment")) %>%
  collect() %>% mutate(FixedLocationID = substring(SampleEventID, 19, 22)) %>% #Create FixedLocationID column and filter to matching IDs
  filter(FixedLocationID %in% dboFixedLocations$FixedLocationID)
#Repro
hsdbRepro <- tbl(con,in_schema("hsdb", "Repro")) %>%
  collect() %>% mutate(FixedLocationID = substring(SampleEventID, 19, 22)) %>% #Create FixedLocationID column and filter to matching IDs
  filter(FixedLocationID %in% dboFixedLocations$FixedLocationID)
dboRepro <- tbl(con,in_schema("dbo", "Repro")) %>%
  collect() %>% mutate(FixedLocationID = substring(SampleEventID, 19, 22)) %>% #Create FixedLocationID column and filter to matching IDs
  filter(FixedLocationID %in% dboFixedLocations$FixedLocationID)
#PBC Sediment
#Survey

DBI::dbDisconnect(con)
```

```{r WQ data tables}

#List of WQ params
WQ_params <- c("DO","Pct", "pH", "Sal", "SP", "Temp")

#Combined table of all parameters
WQ_combined <- left_join(rbind((hsdbSampleEventWQ %>% filter(DataStatus == "Proofed")), (dboSampleEventWQ %>% filter(DataStatus == "Proofed"))) %>%
  #Create date columns and Secchi penetration
  mutate(RetDate = as.Date(substring(SampleEventID, 8, 15), format = "%Y%m%d"),
         AnalysisDate = as.Date(floor_date(RetDate, unit = "month")),
         SP = round((Secchi/Depth) * 100, 2)) %>%
  #Filter data to desired date range and select columns needed for summary
  filter(RetDate > Start_date & RetDate < End_date) %>%
  dplyr::select(AnalysisDate, RetDate, SampleEventWQID, SampleEventID, FixedLocationID, DissolvedOxygen, PercentDissolvedOxygen, pH, Salinity, SP, Temperature) %>% rename(DO = DissolvedOxygen, Pct = PercentDissolvedOxygen, Sal = Salinity, Temp = Temperature) %>%
  #Arrange by station then date
  arrange(match(FixedLocationID, c(LocationID_order)), AnalysisDate),
  #Add simplified StationName 
  dboFixedLocations %>% 
    mutate(StationName = paste0(Estuary, "-", SectionName, StationNumber),
           Site = paste0(Estuary, "-", SectionName)) %>%
    dplyr::select(FixedLocationID, Site, StationName))

##WQ output summary
WQ_out_list <- list()
for(w in WQ_params){
  WQ_Out <- WQ_combined %>% group_by(StationName, AnalysisDate) %>% summarise(across(where(is.numeric), list(sum=sum))) %>% rename_with(~sub("_sum", "", .x)) #across(everything(), ~sum(!is.na(.))))
  WQ_out_w <- WQ_Out %>% dplyr::select(StationName, AnalysisDate, w) %>% pivot_wider(names_from = StationName, values_from = w) %>% mutate(AnalysisDate = str_replace(AnalysisDate, "-01", "")) %>% ungroup()
  WQ_out_list[[w]] <- WQ_out_w
}

##Summary by Station
#Create empty data frame with analysis dates
Station_summary <- data.frame(AnalysisDate = unique(WQ_combined$AnalysisDate))#WQ_combined %>% distinct(Site, RetDate))
for(i in WQ_params){
  for(j in Station_order){
    Summary_jS <- WQ_combined %>% 
      #Select columns for each WQ param, filter to Station by FixedLocationID, and group for summary
      dplyr::select(StationName, AnalysisDate, RetDate, all_of(i)) %>% filter(StationName == j) %>% group_by(AnalysisDate, RetDate) %>% dplyr::select(-StationName) %>%
      #Rename columns: Add StationName to beginning, reformat RetDate for cleaning
      rename_with(.fn = ~ifelse(.x != "AnalysisDate", paste0(j, "_", .x), .x), .cols = -all_of("AnalysisDate")) %>% rename_with(.fn = ~ifelse(str_detect(.x, "RetDate"), paste0(j,"_", "RetDate_", i), .x), .cols = everything())
    #
    #Join with existing data
    Station_summary <- left_join(Station_summary, Summary_jS, by = "AnalysisDate")
  #Clean columns for selection and output
  Station_summ <- Station_summary %>% dplyr::select(-contains(Date_exclusion)) %>% rename_with(~sub("(\\d)_RetDate", "_RetDate", .x)) %>%
    mutate(across(where(is.numeric), round, 2))
  }
}


##Summary by Site
#Create empty data frame with analysis dates
Site_summary <- data.frame(AnalysisDate = unique(WQ_combined$AnalysisDate))#WQ_combined %>% distinct(Site, RetDate))
for(i in WQ_params){
  for(j in Sites){
    Summary_j <- WQ_combined %>% 
      #Select columns for each WQ param, filter to Site, and group for summary
      dplyr::select(Site, AnalysisDate, RetDate, i) %>% filter(Site == j) %>% group_by(AnalysisDate, RetDate) %>% 
      #Calculate mean, SD, min, and max of parameter
      summarise(across(.cols = where(is.numeric), .fns = list(A_Mean = mean, B_SD = sd, C_Min = min, D_Max = max), na.rm = T, .names = "{fn}{col}")) %>% 
      #Rename columns: Add Site to beginning, reformat RetDate for cleaning
      rename_with(.fn = ~ifelse(.x != "AnalysisDate", paste0(j, "_", .x), .x), .cols = -all_of("AnalysisDate")) %>% rename_with(.fn = ~ifelse(str_detect(.x, "RetDate"), paste0(j,"_A_", i, "_RetDate"), .x), .cols = everything())
    #
    #Join with existing data
    Site_summary <- left_join(Site_summary, Summary_j, by = "AnalysisDate")
  }
  #Clean columns for selection and output
  Site_summ <- Site_summary %>% rename_with(., function(x){str_replace(x, "(\\_)[A-Z]","")}) %>%
    mutate(across(where(is.numeric), round, 2)) %>% mutate(across(where(is.numeric), ~na_if(.x, Inf))) %>% mutate(across(where(is.numeric), ~na_if(.x, -Inf)))

}
#
#
if(Append_new_data == "Y" | Append_new_data == "WQ"){
  #Load each sheet and append new data
  DO_Station <- readWorkbook("WQ_Summary_Data.xlsx", sheet = 'DO Station', detectDates = TRUE) %>% bind_rows(Station_summ %>% dplyr::select(contains("DO")))
  DO_Site <- readWorkbook("WQ_Summary_Data.xlsx", sheet = 'DO Site', detectDates = TRUE) %>% bind_rows(Site_summ %>% dplyr::select(contains("DO")))
  DOPct_Station <- readWorkbook("WQ_Summary_Data.xlsx", sheet = 'DO% Station', detectDates = TRUE) %>% bind_rows(Station_summ %>% dplyr::select(contains("Pct")))
  DOPct_Site <- readWorkbook("WQ_Summary_Data.xlsx", sheet = 'DO% Site', detectDates = TRUE) %>% bind_rows(Site_summ %>% dplyr::select(contains("Pct"))) 
  pH_Station <- readWorkbook("WQ_Summary_Data.xlsx", sheet = 'pH Station', detectDates = TRUE) %>% bind_rows(Station_summ %>% dplyr::select(contains("pH")))
  pH_Site <- readWorkbook("WQ_Summary_Data.xlsx", sheet = 'pH Site', detectDates = TRUE) %>% bind_rows(Site_summ %>% dplyr::select(contains("pH")))
  Sal_Station <- readWorkbook("WQ_Summary_Data.xlsx", sheet = 'Salinity Station', detectDates = TRUE) %>% bind_rows(Station_summ %>% dplyr::select(contains("Sal")))
  Sal_Site <- readWorkbook("WQ_Summary_Data.xlsx", sheet = 'Salinity Site', detectDates = TRUE) %>% bind_rows(Site_summ %>% dplyr::select(contains("Sal")))
  SP_Station <- readWorkbook("WQ_Summary_Data.xlsx", sheet = 'Secchi Station', detectDates = TRUE) %>% bind_rows(Station_summ %>% dplyr::select(contains("SP")))
  SP_Site <- readWorkbook("WQ_Summary_Data.xlsx", sheet = 'Secchi Site', detectDates = TRUE) %>% bind_rows(Site_summ %>% dplyr::select(contains("SP")))
  Temp_Station <- readWorkbook("WQ_Summary_Data.xlsx", sheet = 'Temp Station', detectDates = TRUE) %>% bind_rows(Station_summ %>% dplyr::select(contains("Temp")))
  Temp_Site <- readWorkbook("WQ_Summary_Data.xlsx", sheet = 'Temp Site', detectDates = TRUE) %>% bind_rows(Site_summ %>% dplyr::select(contains("Temp")))
  
  #Load workbook of existing data
  WQ_wb <- loadWorkbook("WQ_Summary_Data.xlsx")
  #Overwrite each sheet with new data appended to old
  writeData(WQ_wb, "DO Station", DO_Station)
  writeData(WQ_wb, "DO Site", DO_Site)
  writeData(WQ_wb, "DO% Station", DOPct_Station)
  writeData(WQ_wb, "DO% Site", DOPct_Site)
  writeData(WQ_wb, "pH Station", pH_Station)
  writeData(WQ_wb, "pH Site", pH_Site)
  writeData(WQ_wb, "Salinity Station", Sal_Station)
  writeData(WQ_wb, "Salinity Site", Sal_Site)
  writeData(WQ_wb, "Secchi Station", SP_Station)
  writeData(WQ_wb, "Secchi Site", SP_Site)
  writeData(WQ_wb, "Temp Station", Temp_Station)
  writeData(WQ_wb, "Temp Site", Temp_Site)
  #Save workbook
  saveWorkbook(WQ_wb, "WQ_Summary_Data.xlsx", overwrite=TRUE)
} else {
  print("Water quality data was not appended within Excel summary file.")
  }
```

```{r Dermo data tables}

#Combined table of all parameters
Dermo_combined <- left_join(rbind((hsdbDermo %>% dplyr::select(-OldSampleNumber) %>% filter(DataStatus == "Proofed")), (dboDermo %>% filter(DataStatus == "Proofed"))) %>%
  #Create date columns 
  mutate(RetDate = as.Date(substring(SampleEventID, 8, 15), format = "%Y%m%d"),
         AnalysisDate = as.Date(floor_date(RetDate, unit = "month")),
         DermoSum = as.numeric(ifelse(rowSums(select(., contains("Dermo"))) >0, 1, 0))) %>%
  #Filter data to desired date range and select columns needed for summary
  filter(RetDate > Start_date & RetDate < End_date) %>%
  dplyr::select(AnalysisDate, RetDate, OysterID, SampleEventID, FixedLocationID, DermoMantle, DermoGill, DermoSum) %>% 
  #Arrange by station then date
  arrange(match(FixedLocationID, c(LocationID_order)), AnalysisDate),
  #Add simplified StationName 
  dboFixedLocations %>% 
    mutate(StationName = paste0(Estuary, "-", SectionName, StationNumber),
           Site = paste0(Estuary, "-", SectionName)) %>%
    dplyr::select(FixedLocationID, Site, StationName))

##Dermo output summary
Dermo_out <- Dermo_combined %>% group_by(StationName, AnalysisDate) %>% summarise(Mean = mean(DermoSum, na.rm = T)) %>% pivot_wider(names_from = StationName, values_from = Mean)

##Summary by Station
#Create empty data frame with analysis dates
Station_summary_D <- data.frame(AnalysisDate = unique(WQ_combined$AnalysisDate))
for(j in Station_order){
  Summary_jD <- Dermo_combined %>% 
    #Select columns, filter to Station by FixedLocationID, and group for summary
    dplyr::select(StationName, AnalysisDate, RetDate, DermoMantle:DermoSum) %>% filter(StationName == j) %>% group_by(AnalysisDate, RetDate) %>%
    #Calculate Mean, SD, and Pct dermo
    summarise(Mean = mean(DermoSum, na.rm = T), SD = sd(DermoSum, na.rm = T), Pct = (sum(DermoSum, na.rm = T)/n())*100) %>%
    #Rename columns: Add StationName to beginning, reformat RetDate for cleaning
    rename_with(.fn = ~ifelse(.x != "AnalysisDate", paste0(j, "_", .x), .x), .cols = -all_of("AnalysisDate")) 
  #
  #Join with existing data
  Station_summary_D <- left_join(Station_summary_D, Summary_jD, by = "AnalysisDate")
  #Clean columns for selection and output
  Station_summ_D <- Station_summary_D %>% dplyr::select(-contains(Date_exclusion)) %>% rename_with(~sub("(\\d)_RetDate", "_RetDate", .x)) %>%
    mutate(across(where(is.numeric), round, 2))
  }


##Summary by Site
#Create empty data frame with analysis dates
Site_summary_D <- data.frame(AnalysisDate = unique(WQ_combined$AnalysisDate))
for(j in Sites){
  Summary_jD <- Dermo_combined  %>% 
    #Select columns for each WQ param, filter to Site, and group for summary
    dplyr::select(Site, AnalysisDate, RetDate, DermoMantle:DermoSum) %>% filter(Site == j) %>% group_by(AnalysisDate, RetDate) %>% 
    #Calculate mean, SD, min, and max of parameter
    summarise(Mean = mean(DermoSum, na.rm = T), SD = sd(DermoSum, na.rm = T), Pct = (sum(DermoSum, na.rm = T)/n())*100) %>% 
    #Rename columns: Add Site to beginning, reformat RetDate for cleaning
    rename_with(.fn = ~ifelse(.x != "AnalysisDate", paste0(j, "_", .x), .x), .cols = -all_of("AnalysisDate")) 
  #
  #Join with existing data
  Site_summary_D <- left_join(Site_summary_D, Summary_jD, by = "AnalysisDate")
  #Clean columns for selection and output
  Site_summ_D <- Site_summary_D %>% mutate(across(where(is.numeric), round, 2)) %>% mutate(across(where(is.numeric), ~na_if(.x, Inf))) %>%
    mutate(across(where(is.numeric), ~na_if(.x, -Inf)))
  }
#
#
if(Append_new_data == "Y" | Append_new_data == "Dermo"){
  #Load each sheet and append new data
  Dermo_Station <- readWorkbook("Summary_Data.xlsx", sheet = 'Dermo Station', detectDates = TRUE) %>% bind_rows(Station_summ_D)
  Dermo_Site <- readWorkbook("Summary_Data.xlsx", sheet = 'Dermo Site', detectDates = TRUE) %>% bind_rows(Site_summ_D)
  
  #Load workbook of existing data
  Data_wb <- loadWorkbook("Summary_Data.xlsx")
  #Overwrite each sheet with new data appended to old
  writeData(Data_wb, "Dermo Station", Dermo_Station)
  writeData(Data_wb, "Dermo Site", Dermo_Site)
   #Save workbook
  saveWorkbook(Data_wb, "Summary_Data.xlsx", overwrite=TRUE)
} else {
  print("Dermo data was not appended within Excel summary file.")
  }
```

```{r Recruitment data tables}

#Combined table of all parameters
Rcrt_combined <- left_join(rbind((hsdbRcrt %>% filter(DataStatus == "Proofed")), (dboRcrt %>% filter(DataStatus == "Proofed"))) %>%
  #Create date columns 
  mutate(RetDate = as.Date(substring(SampleEventID, 8, 15), format = "%Y%m%d"),
         DeployedDate = as.Date(DeployedDate, format = "%Y-%m-%d"),
         AnalysisDate = as.Date(floor_date(RetDate, unit = "month")),
         BottomMonth = NumBottom/(as.numeric(RetDate-DeployedDate)/28)) %>%
  #Filter data to desired date range and select columns needed for summary
  filter(RetDate > Start_date & RetDate < End_date) %>%
  dplyr::select(AnalysisDate, RetDate, ShellID, SampleEventID, FixedLocationID, BottomMonth) %>% 
  #Arrange by station then date
  arrange(match(FixedLocationID, c(LocationID_order)), AnalysisDate),
  #Add simplified StationName 
  dboFixedLocations %>% 
    mutate(StationName = paste0(Estuary, "-", SectionName, StationNumber),
           Site = paste0(Estuary, "-", SectionName)) %>%
    dplyr::select(FixedLocationID, Site, StationName))

##Recruitment output summary
Rcrt_out <- Rcrt_combined %>% group_by(StationName, AnalysisDate) %>% summarise(Mean = round(mean(BottomMonth, na.rm = T),2)) %>% pivot_wider(names_from = StationName, values_from = Mean)

##Summary by Station
#Create empty data frame with analysis dates
Station_summary_R <- data.frame(AnalysisDate = unique(WQ_combined$AnalysisDate))
for(j in Station_order){
  Summary_jR <- Rcrt_combined %>% 
    #Select columns, filter to Station by FixedLocationID, and group for summary
    dplyr::select(StationName, AnalysisDate, RetDate, BottomMonth) %>% filter(StationName == j) %>% group_by(AnalysisDate, RetDate) %>%
    #Calculate Mean, SD, and Pct dermo
    summarise(Mean = mean(BottomMonth, na.rm = T), SD = sd(BottomMonth, na.rm = T)) %>%
    #Rename columns: Add StationName to beginning, reformat RetDate for cleaning
    rename_with(.fn = ~ifelse(.x != "AnalysisDate", paste0(j, "_", .x), .x), .cols = -all_of("AnalysisDate")) 
  #
  #Join with existing data
  Station_summary_R <- left_join(Station_summary_R, Summary_jR, by = "AnalysisDate")
  #Clean columns for selection and output
  Station_summ_R <- Station_summary_R %>% dplyr::select(-contains(Date_exclusion)) %>% rename_with(~sub("(\\d)_RetDate", "_RetDate", .x)) %>%
    mutate(across(where(is.numeric), round, 2))
  }


##Summary by Site
#Create empty data frame with analysis dates
Site_summary_R <- data.frame(AnalysisDate = unique(WQ_combined$AnalysisDate))
for(j in Sites){
  Summary_jR <- Rcrt_combined  %>% 
    #Select columns for each WQ param, filter to Site, and group for summary
    dplyr::select(Site, AnalysisDate, RetDate, BottomMonth) %>% filter(Site == j) %>% group_by(AnalysisDate, RetDate) %>% 
    #Calculate mean, SD, min, and max of parameter
    summarise(Mean = mean(BottomMonth, na.rm = T), SD = sd(BottomMonth, na.rm = T)) %>% 
    #Rename columns: Add Site to beginning, reformat RetDate for cleaning
    rename_with(.fn = ~ifelse(.x != "AnalysisDate", paste0(j, "_", .x), .x), .cols = -all_of("AnalysisDate")) 
  #
  #Join with existing data
  Site_summary_R <- left_join(Site_summary_R, Summary_jR, by = "AnalysisDate")
  #Clean columns for selection and output
  Site_summ_R <- Site_summary_R %>% mutate(across(where(is.numeric), round, 2)) %>% mutate(across(where(is.numeric), ~na_if(.x, Inf))) %>%
    mutate(across(where(is.numeric), ~na_if(.x, -Inf)))
  }
#
#
if(Append_new_data == "Y" | Append_new_data == "Rcrt"){
  #Load each sheet and append new data
  Rcrt_Station <- readWorkbook("Summary_Data.xlsx", sheet = 'Rcrt Station', detectDates = TRUE) %>% bind_rows(Station_summ_R)
  Rcrt_Site <- readWorkbook("Summary_Data.xlsx", sheet = 'Rcrt Site', detectDates = TRUE) %>% bind_rows(Site_summ_R)
  
  #Load workbook of existing data
  Data_wb <- loadWorkbook("Summary_Data.xlsx")
  #Overwrite each sheet with new data appended to old
  writeData(Data_wb, "Rcrt Station", Rcrt_Station)
  writeData(Data_wb, "Rcrt Site", Rcrt_Site)
   #Save workbook
  saveWorkbook(Data_wb, "Summary_Data.xlsx", overwrite=TRUE)
} else {
  print("Recruitment data was not appended within Excel summary file.")
  }
```

```{r Repro data tables}

#List of Repro stages
Stages <- c("Dev","Rip", "Spe", "Ind")

#Combined table of all parameters
Repro_combined <- left_join(rbind((hsdbRepro %>% dplyr::select(-OldSampleNumber) %>% filter(DataStatus == "Proofed")), (dboRepro %>% filter(DataStatus == "Proofed"))) %>%
  #Create date columns 
  mutate(RetDate = as.Date(substring(SampleEventID, 8, 15), format = "%Y%m%d"),
         AnalysisDate = as.Date(floor_date(RetDate, unit = "month")),
         ReproStage = as.factor(ReproStage)) %>%
  #Filter data to desired date range and select columns needed for summary
  filter(RetDate > Start_date & RetDate < End_date) %>%
  dplyr::select(AnalysisDate, RetDate, OysterID, SampleEventID, FixedLocationID, ReproStage) %>% 
  #Arrange by station then date
  arrange(match(FixedLocationID, c(LocationID_order)), AnalysisDate),
  #Add simplified StationName 
  dboFixedLocations %>% 
    mutate(StationName = paste0(Estuary, "-", SectionName, StationNumber),
           Site = paste0(Estuary, "-", SectionName)) %>%
    dplyr::select(FixedLocationID, Site, StationName))

##Repro output summary (Developing or Ripe Oysters)
Repro_out <- left_join(Repro_combined %>% group_by(Site, AnalysisDate) %>% filter(ReproStage == "1" | ReproStage == "2") %>% summarise(Count = n()), Repro_combined %>% group_by(Site, AnalysisDate) %>% summarise(Total = n()))  %>%  mutate(Pct = round((Count/Total)*100,2)) %>% dplyr::select(-Count, -Total) %>% pivot_wider(names_from = Site, values_from = Pct) %>% arrange(AnalysisDate) %>% mutate(across(everything(), ~replace_na(., 0)))


##Summary by Site
#Create empty data frame with analysis dates
Site_summary_Re <- data.frame(AnalysisDate = unique(WQ_combined$AnalysisDate))
for(j in Sites){
  for(s in Stages){
    Repro_comb <- Repro_combined %>% mutate(ReproStage = factor(ReproStage, levels = c("1", "2", "3", "4", "Z"), labels = c("Dev", "Rip", "Spe", "Ind", "Z"))) %>% filter(ReproStage != "Z")
    Repro_RetDates <- Repro_comb %>% filter(Site == j) %>% distinct(AnalysisDate, RetDate) %>% rename_with(.fn = ~ifelse(.x != "AnalysisDate", paste0(j, "_", .x), .x))
    Summary_jRe <- left_join(Repro_comb  %>% 
                               #Select columns, filter to Station by FixedLocationID, and group by ReproStage for Count
                               dplyr::select(Site, AnalysisDate, ReproStage) %>% filter(Site == j & ReproStage == s) %>% group_by(AnalysisDate, ReproStage) %>% summarise(Count = n()), 
                             Repro_comb %>% 
                               #Repeat for total number of samples
                               dplyr::select(Site, AnalysisDate, ReproStage) %>% filter(Site == j) %>% group_by(AnalysisDate) %>%
                               summarise(Total = n())) %>%
      #Determine percent, ranme Stages, remove any "Z"s 
      mutate(Pct = (Count/Total)*100) %>% dplyr::select(-Count, -Total) %>%
      rename_with(., function(x){str_replace(x, "Pct",s)}) %>%
      #Rename columns: Add Site to beginning
      rename_with(.fn = ~ifelse(.x != "AnalysisDate", paste0(j, "_", .x), .x), .cols = -all_of("AnalysisDate")) %>% dplyr::select(-paste0(j,"_ReproStage"))
    #
    #Join with existing data
    Site_summary_Re <- left_join(Site_summary_Re, left_join(Repro_RetDates, Summary_jRe), by = "AnalysisDate")
  }
  #Clean columns for selection and output
  Site_summ_Re <- Site_summary_Re %>% mutate(across(where(is.numeric), round, 2)) %>% mutate(across(where(is.numeric), ~na_if(.x, Inf))) %>%
    mutate(across(where(is.numeric), ~na_if(.x, -Inf))) %>% 
    #Remove unneeded columns and rename/clean remaining
    dplyr::select(-ends_with(c(".y",".x.x"))) %>% rename_with(~sub("RetDate.x", "_RetDate", .x)) %>% mutate(across(everything(), ~replace_na(., 0)))
}
#
#
if(Append_new_data == "Y" | Append_new_data == "Repro"){
  #Load each sheet and append new data
  Repro_Site <- readWorkbook("Summary_Data.xlsx", sheet = 'Repro', detectDates = TRUE) %>% bind_rows(Site_summ_Re)
  
  #Load workbook of existing data
  Data_wb <- loadWorkbook("Summary_Data.xlsx")
  #Overwrite each sheet with new data appended to old
  writeData(Data_wb, "Repro", Repro_Site)
   #Save workbook
  saveWorkbook(Data_wb, "Summary_Data.xlsx", overwrite=TRUE)
} else {
  print("Repro data was not appended within Excel summary file.")
  }
```

```{r ReportText}
#Report Text in area below
```
## Report summary
This data summary was compiled by `r Author` on `r format(Sys.Date(), "%d %B %Y")` and summarizes data for **CERP** and **PBC** sites. Mean values are shown.\

## Water Quality summary
Water quality data covers sites and stations from `r min(WQ_combined$AnalysisDate) %>% format("%B %Y")` through `r max(WQ_combined$AnalysisDate) %>% format("%B %Y")`.\
`r kable(WQ_out_list[1], caption = "Dissovled oxygen data")`
`r kable(WQ_out_list[2], caption = "Percent dissovled oxygen data")`
`r kable(WQ_out_list[3], caption = "pH data")`
`r kable(WQ_out_list[4], caption = "Salinity data")`
`r kable(WQ_out_list[5], caption = "Secchi penetration data")`
`r kable(WQ_out_list[6], caption = "Temperature data")`

## Dermo summary
Dermo data covers sites and stations from `r min(WQ_combined$AnalysisDate) %>% format("%B %Y")` through `r max(WQ_combined$AnalysisDate) %>% format("%B %Y")`.\
`r kable(Dermo_out, caption = "Dermo data")`

## Recruitment summary
Recruitment data covers sites and stations from `r min(WQ_combined$AnalysisDate) %>% format("%B %Y")` through `r max(WQ_combined$AnalysisDate) %>% format("%B %Y")`.\
`r kable(Rcrt_out, caption = "Recruitment data")`

## Repro summary
Repro data covers sites and stations from `r min(WQ_combined$AnalysisDate) %>% format("%B %Y")` through `r max(WQ_combined$AnalysisDate) %>% format("%B %Y")`. Percentages are given as total percentage of Developing and Ripe oysters.\
`r kable(Repro_out, caption = "Repro data")`