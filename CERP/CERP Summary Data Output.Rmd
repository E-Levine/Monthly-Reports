---
title: "Summary_Data_Output"
author: "ELevine"
date: "2024-06-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

Author <- c("E Levine") #Change to your name
Database <- "Oysters_24 06 05"  #Set the local database to use
Server = "localhost\\ERICALOCALSQL" #Set the local Server to use

Start_date <- as.Date("2024-01-01")
End_date <- as.Date("2024-06-30")

#Packages
if (!require("pacman")) {install.packages("pacman")}
pacman::p_load(odbc, DBI, dbplyr,
  tidyverse, dplyr,  #DF manipulation
  DT,          #Excel
  lubridate, zoo,         #Dates
  knitr, 
  install = TRUE)

Estuaries <- c("SL", "LX", "CR", "LW")
Sites <- c("CR-E", "CR-W", "LW-L", "LW-R", "LX-N", "LX-S", "SL-C", "SL-N", "SL-S")
CR_order <- c("0230", "0231", "0232", "0233",  #CR
              "0235", "0236", "0237", "0240", "0241", "0312", #LW
              "0242", "0243", "0244", "0246", "0247", "0249", #LX
              "0255", "0256", "0257", "0261", "0262", "0264", "0269", "0270", "0271") #SL
CR_order <- c("CR-E", "CR-E1", "CR-E2", "CR-W", "CR-W3", "CR-W4", #CR
              "0236", "0237", "0240", "0241", "0312", #LW
              "0242", "0243", "0244", "0246", "0247", "0249", #LX
              "0255", "0256", "0257", "0261", "0262", "0264", "0269", "0270", "0271") #SL

```


```{r DatabaseDownload}
# Connect to Local database server and pull all necessary data, then close connection 
con <- dbConnect(odbc(),
                    Driver = "SQL Server", 
                    Server = Server,
                    Database = Database,
                    Authentication = "ActiveDirectoryIntegrated")

dboFixedLocations <- tbl(con,in_schema("dbo", "FixedLocations")) %>%
  collect() %>% 
  filter(Estuary %in% Estuaries & grepl("^0", FixedLocationID)) %>% #Limit to primary stations, remove "ARRA" and SLN4
  filter(!grepl("^ARRA", StationName) & StationName != "SL-N-4")
hsdbSampleEventWQ <- tbl(con,in_schema("hsdb", "SampleEventWQ")) %>%
  collect() %>% mutate(FixedLocationID = substring(SampleEventID, 19, 22)) %>% #Create FixedLocationID column and filter to matching IDs
  filter(FixedLocationID %in% dboFixedLocations$FixedLocationID & str_detect(SampleEventWQID, 'COLL')) #Limit to COLL (dermo) data
dboSampleEventWQ <- tbl(con,in_schema("dbo", "SampleEventWQ")) %>%
  collect() %>% mutate(FixedLocationID = substring(SampleEventID, 19, 22)) %>% #Create FixedLocationID column and filter to matching IDs
  filter(FixedLocationID %in% dboFixedLocations$FixedLocationID & str_detect(SampleEventWQID, 'COLL')) #Limit to COLL (dermo) data

DBI::dbDisconnect(con)
```

```{r WQ data tables}

#List of WQ params
WQ_params <- c("DO","Pct", "pH", "Sal", "SP", "Temp")

#Combined table of all parameters
WQ_combined <- left_join(rbind((hsdbSampleEventWQ %>% filter(DataStatus == "Proofed")), (dboSampleEventWQ %>% filter(DataStatus == "Proofed"))) %>%
  #Create date columns and Secchi penetration
  mutate(RetDate = as.Date(substring(SampleEventID, 8, 15), format = "%Y%m%d"),
         AnalysisDate = as.Date(floor_date(RetDate, unit = "month")),
         SP = round((Secchi/Depth) * 100, 2)) %>%
  #Filter data to desired date range and select columns needed for summary
  filter(RetDate > Start_date & RetDate < End_date) %>%
  dplyr::select(AnalysisDate, RetDate, SampleEventWQID, SampleEventID, FixedLocationID, DissolvedOxygen, PercentDissolvedOxygen, pH, Salinity, SP, Temperature) %>% rename(DO = DissolvedOxygen, Pct = PercentDissolvedOxygen, Sal = Salinity, Temp = Temperature) %>%
  #Arrange by station then date
  arrange(match(FixedLocationID, c(CR_order)), AnalysisDate),
  #Add simplified StationName 
  dboFixedLocations %>% 
    mutate(StationName = paste0(Estuary, "-", SectionName, StationNumber),
           Site = paste0(Estuary, "-", SectionName)) %>%
    dplyr::select(FixedLocationID, Site, StationName))

#Summary by Site
Site_summary <- data.frame()#WQ_combined %>% distinct(Site, RetDate))
Site_summary_l <- data.frame()
WQ_list <- list()
for(j in Estuaries){
  for(i in WQ_params){
    WQ_Sites_i <- WQ_combined %>% dplyr::select(Site, RetDate, i) %>%
      group_by(Site, RetDate) %>%
      summarise(A_Mean = round(mean(get(i), na.rm = T),2),
                B_SD = round(sd(get(i), na.rm = T),2),
                C_Min = min(get(i), na.rm = T),
                D_Max = max(get(i), na.rm = T)) %>%
      rename_with(~paste0(., i), -which(names(.) == c("Site", "RetDate")))
    
    WQ_Sites_ij <- WQ_Sites_i %>% filter(str_detect(Site, j)) %>% 
    pivot_wider(names_from = Site, values_from = c(3:6), names_glue = "{Site}_{.value}", values_fill = NA) %>%
    dplyr::select(RetDate, sort(colnames(.)))
    
    Site_summary <- rbind(Site_summary, WQ_Sites_i)
    WQ_list[[i]][[j]] <- WQ_Sites_ij
  }
}

##Try 2
#Get summary by Site for all parameters
Site_summary <- list() #data.frame()#matrix(nrow = length(unique(WQ_combined$AnalysisDate)), ncol = 25*9)#WQ_combined %>% distinct(Site, RetDate))
for(i in WQ_params){
for (j in Sites) {
  Summary_j <- WQ_combined %>% filter(str_detect(Site, j)) %>% dplyr::select(Site, RetDate, DO:Temp) %>% group_by(RetDate) %>% summarise(across(.cols = where(is.numeric), .fns = list(A_Mean = mean, B_SD = sd, C_Min = min, D_Max = max), na.rm = T, .names = "{fn}{col}")) %>% rename_with(., function(x){paste0(j, "_", x)})
  
  Site_summary[[j]] <- Summary_j
}
  #WORKING
  map(Site_summary, ~.x %>% dplyr::select(contains(c("Date", "DO")))) %>% reduce(.,bind_cols)
}
(temp <- WQ_combined %>% filter(str_detect(Site, 'CR-E')) %>% dplyr::select(Site, RetDate, DO:Temp) %>% group_by(RetDate) %>% summarise(across(.cols = where(is.numeric), .fns = list(A_Mean = mean, B_SD = sd, C_Min = min, D_Max = max), na.rm = T, .names = "CR-E_{fn}{col}")) %>% rename("CR-E_RetDate" = RetDate))

temp %>% dplyr::select('CR-E_RetDate', contains("DO"))

WQ_list

```
