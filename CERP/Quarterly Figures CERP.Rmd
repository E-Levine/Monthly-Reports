---
title: "Quarterly Figures CERP"
author: "ELevine"
date: "`r Sys.Date()`"
output: 
  word_document: 
    reference_docx: Monthly-Reports-template.docx
params:
  Start_date: "2024-07-01" #Start date of reporting quarter
  End_date: "2024-09-30"   #End date of reporting quarter
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
#
Start_date <- as.Date(params$Start_date)
End_date <- as.Date(params$End_date)

#Packages
if (!require("pacman")) {install.packages("pacman")}
#p_unlock()
pacman::p_load(odbc, DBI, dbplyr,
  tidyverse, dplyr,  stringr, #DF manipulation
  DT, openxlsx,         #Excel
  lubridate, zoo,         #Dates
  knitr, kableExtra, scales, gt, gtExtras, ggpubr,
  install = TRUE)
```

```{r ConfigureChunks, warning=FALSE, include=FALSE}
# Configure chunks

```

```{r FigureFormatting}
#Base formatting for figure consistency
BaseForm <- theme_classic() +
  theme(panel.border = element_rect(color = "black", fill = NA), #Add border
        axis.title = element_text(family = "serif", color = "black", size = 16), #Adjust axis title and text
        axis.text = element_text(family = "serif", color = "black", size = 12), axis.text.x = element_text(angle = 45, hjust = 1),
        axis.line = element_line(color = "black"),
        axis.ticks.length.x = unit(0.10, "cm"),
        axis.ticks.length.y = unit(0.15, "cm"))
East_legend <- theme(legend.position = "inside", legend.position.inside = c(.155, .995), legend.justification = c("right", "top"), legend.box.just = "right", legend.box.spacing = unit(0.15, "lines"), #Adjust legend position
                     legend.background = element_rect(color = "black", fill = "white", linetype = "solid"),
                     legend.title = element_blank(), legend.key.height = unit(0.7, "lines"), legend.key.spacing.y = unit(0.25, "lines"),
                     legend.key.width = unit(1.5, "lines"), #Adjust legend title and spacing
                     legend.text = element_text(family = "serif", color = "black", size = 12))
West_legend <- theme(legend.position = "inside", legend.position.inside = c(0.005, .980), legend.justification = c("left", "top"), legend.box.just = "left", legend.box.spacing = unit(0.25, "lines"), #Adjust legend position
                     legend.background = element_rect(color = "black", fill = "white", linetype = "solid"),
                     legend.title = element_blank(), legend.key.height = unit(0.7, "lines"), legend.key.spacing.y = unit(0.25, "lines"),
                     legend.key.width = unit(1.5, "lines"), #Adjust legend title and spacing
                     legend.text = element_text(family = "serif", color = "black", size = 12, margin = margin(r = 6, l = 5)))
FacetForm <- theme(strip.placement = "outside", strip.text.x.top = element_text(vjust = 1, hjust = 0, size = 13, family = "serif"), strip.clip = "off", panel.spacing.y = unit(0.5, "lines"), strip.background = element_blank())
PlotTitle <- theme(plot.title = element_text(size = 13, family = "serif"))# strip.placement = "outside", strip.text.x.top = element_text(vjust = 1, hjust = 0), strip.clip = "off", panel.spacing.y = unit(0.5, "lines"), strip.background = element_blank())


#Color and shape to station number - East
Stat_pal <- c(rgb(0, 0, 228, maxColorValue = 255), rgb(245, 0, 0, maxColorValue = 255), rgb(0, 118, 0, maxColorValue = 255))
Stations_E <- c("1" = "Station 1", "2" = "Station 2", "3" = "Station 3") 
Station_fill_E <- scale_fill_manual("", labels = Stations_E, values = setNames(Stat_pal, 1:3), na.value = "#999999")
Station_color_E <- scale_color_manual("", labels = Stations_E, values = setNames(Stat_pal, 1:3), na.value = "#999999")
Station_shape_E <- scale_shape_manual("",labels = Stations_E, values = setNames(c(21, 25, 22), 1:3))

#Color and shape to station number - West
Stat_pal2 <- c(rgb(0, 0, 228, maxColorValue = 255), rgb(245, 0, 0, maxColorValue = 255), rgb(0, 0, 228, maxColorValue = 255), rgb(245, 0, 0, maxColorValue = 255))
Stations_W <- c("1" = "Peppertree Pointe", "2" = "Iona Cove", "3" = "Bird Island", "4" = "Kitchel Key") 
Station_fill_W <- scale_fill_manual("", labels = Stations_W, values = setNames(Stat_pal2, 1:4), na.value = "#999999")
Station_color_W <- scale_color_manual("", labels = Stations_W, values = setNames(Stat_pal2, 1:4), na.value = "#999999")
Station_shape_W <- scale_shape_manual("",labels = Stations_W, values = setNames(c(21, 25, 21, 25), 1:4))
#
```

```{r Data gather from summary file}
WQ_Sal_s <-  readWorkbook("WQ_Summary_Data.xlsx", sheet = 'Salinity Station', detectDates = TRUE, check.names = TRUE)
WQ_Secchi_s <-  readWorkbook("WQ_Summary_Data.xlsx", sheet = 'Secchi Station', detectDates = TRUE, check.names = TRUE)
Dermo_df <- readWorkbook("Summary_Data.xlsx", sheet = 'Dermo Station', detectDates = TRUE, check.names = TRUE)
Rcrt_df <- readWorkbook("Summary_Data.xlsx", sheet = 'Rcrt Station', detectDates = TRUE, check.names = TRUE)
Repro_df <- readWorkbook("Summary_Data.xlsx", sheet = 'Repro', detectDates = TRUE, check.names = TRUE)
Counts_df <- readWorkbook("Summary_Data.xlsx", sheet = 'DeadRatio Station', detectDates = TRUE, check.names = TRUE)
SH_df <- readWorkbook("Summary_Data.xlsx", sheet = 'SH Station', detectDates = TRUE, check.names = TRUE)
Cage_df <- readWorkbook("Summary_Data.xlsx", sheet = 'SH Mort Cage', detectDates = TRUE, check.names = TRUE)
Sedi_sta <- readWorkbook("Summary_Data.xlsx", sheet = 'Sedi Stations', detectDates = TRUE, check.names = TRUE)
Sedi_pos <- readWorkbook("Summary_Data.xlsx", sheet = 'Sedi Position', detectDates = TRUE, check.names = TRUE)
```

```{r Data selection and cleaning}
#
##Salinity
names(WQ_Sal_s) <- gsub("\\.", "", names(WQ_Sal_s))
Sal_East_1 <- WQ_Sal_s %>% dplyr::select(contains("SL")|contains("LX")) %>% filter(SLC_RetDate_Sal >= End_date %m-% months(13)) %>%
  dplyr::select(-SLN_RetDate_Sal, -SLS_RetDate_Sal, -LXS_RetDate_Sal) %>% rename("SL_RetDate" = SLC_RetDate_Sal, "LX_RetDate" = LXN_RetDate_Sal)
Sal_East_2 <- rbind(Sal_East_1 %>% dplyr::select(contains("SL")) %>% gather(SiteStation, Salinity, -SL_RetDate) %>% rename("RetDate" = SL_RetDate),
                    Sal_East_1 %>% dplyr::select(contains("LX")) %>% gather(SiteStation, Salinity, -LX_RetDate) %>% rename("RetDate" = LX_RetDate)) %>%
  mutate(Site = factor(substr(SiteStation, 1, 3), levels = c("SLN", "SLS", "SLC", "LXN", "LXS")), Station = as.factor(substr(SiteStation, 4, 4))) 

Sal_West <- WQ_Sal_s %>% dplyr::select(contains("CR")) %>% filter(CRE_RetDate_Sal >= End_date %m-% months(13)) %>% dplyr::select(-CRW_RetDate_Sal) %>% rename("CR_RetDate" = CRE_RetDate_Sal) %>% gather(SiteStation, Salinity, -CR_RetDate) %>% rename("RetDate" = CR_RetDate) %>% mutate(Site = factor(substr(SiteStation, 1, 3), levels = c("CRE", "CRW")), Station = as.factor(substr(SiteStation, 4, 4))) 
#
#
##Secchi
names(WQ_Secchi_s) <- gsub("\\.", "", names(WQ_Secchi_s))
SP_East_1 <- WQ_Secchi_s %>% dplyr::select(contains("SL")|contains("LX")) %>% filter(SLC_RetDate_SP >= End_date %m-% months(13)) %>% dplyr::select(-SLN_RetDate_SP, -SLS_RetDate_SP, -LXS_RetDate_SP) %>% rename("SL_RetDate" = SLC_RetDate_SP, "LX_RetDate" = LXN_RetDate_SP)
SP_East_2 <- rbind(SP_East_1 %>% dplyr::select(contains("SL")) %>% gather(SiteStation, Secchi, -SL_RetDate) %>% rename("RetDate" = SL_RetDate),
                    SP_East_1 %>% dplyr::select(contains("LX")) %>% gather(SiteStation, Secchi, -LX_RetDate) %>% rename("RetDate" = LX_RetDate)) %>%
  mutate(Site = factor(substr(SiteStation, 1, 3), levels = c("SLN", "SLS", "SLC", "LXN", "LXS")), Station = as.factor(substr(SiteStation, 4, 4))) 

SP_West <- WQ_Secchi_s %>% dplyr::select(contains("CR")) %>% filter(CRE_RetDate_SP >= End_date %m-% months(13)) %>% dplyr::select(-CRW_RetDate_SP) %>% rename("CR_RetDate" = CRE_RetDate_SP) %>% gather(SiteStation, Secchi, -CR_RetDate) %>% rename("RetDate" = CR_RetDate) %>% mutate(Site = factor(substr(SiteStation, 1, 3), levels = c("CRE", "CRW")), Station = as.factor(substr(SiteStation, 4, 4))) 
```

```{r CERP Salinity Figure, fig.cap = "Figure 17. Monthly salinity recorded at stations within the five east coast study sites.", fig.height = 10, fig.width = 8, fig.fullwidth=TRUE}
Sal_East_2 %>%
  ggplot(aes(RetDate, Salinity, shape = Station)) + 
  geom_point(aes(fill = Station), size = 2.75) + geom_line(aes(color = Station), linewidth = 0.7) +
  facet_wrap(.~Site, nrow = 5, labeller = as_labeller(c("SLN" = "St. Lucie-North", "SLS" = "St. Lucie-South", "SLC" = "St. Lucie-Central", "LXN" = "Loxahatchee-North", "LXS" = "Loxahatchee-South"))) +
  scale_y_continuous(expand = c(0,0), limits = c(0, 40)) +
  scale_x_date("Date", expand= c(0,0), date_breaks = "1 month", date_labels = "%b %Y", limits = c(End_date %m-% months(12) %m-% days(5), End_date %m-% days(5)))+
  Station_fill_E + Station_color_E + Station_shape_E + BaseForm + FacetForm +East_legend

```

```{r CRE Salinity Figure, fig.cap = "Figure 18. Monthly salinity recorded at stations within the two Caloosahatchee River study sites.", fig.height = 5, fig.width = 8, fig.fullwidth=TRUE}
Sal_West_Fig <- ggarrange(
  Sal_West %>% filter(Station == 1 | Station == 2) %>%
    ggplot(aes(RetDate, Salinity, shape = Station)) + 
    geom_point(aes(fill = Station), size = 2.75) + geom_line(aes(color = Station), linewidth = 0.7) +
    scale_y_continuous(expand = c(0,0), limits = c(0, 40)) +
    scale_x_date("Date", expand= c(0,0), date_breaks = "1 month", date_labels = "%b %Y", limits = c(End_date %m-% months(12) %m-% days(5), End_date %m-% days(5)))+ 
    Station_fill_W + Station_color_W + Station_shape_W + BaseForm + West_legend + 
    labs(title = "Caloosahatchee River-East") + PlotTitle +
    rremove("ylab") + rremove("xlab") + rremove("x.text") + theme(plot.margin = unit(c(0,0.5,0.5,0), "cm")), 
  Sal_West %>% filter(Station == 3 | Station == 4) %>%
    ggplot(aes(RetDate, Salinity, shape = Station)) + 
    geom_point(aes(fill = Station), size = 2.75) + geom_line(aes(color = Station), linewidth = 0.7) +
    scale_y_continuous(expand = c(0,0), limits = c(0, 40)) +
    scale_x_date("Date", expand= c(0,0), date_breaks = "1 month", date_labels = "%b %Y", limits = c(End_date %m-% months(12) %m-% days(5), End_date %m-% days(5)))+
    Station_fill_W + Station_color_W + Station_shape_W + BaseForm + West_legend + 
    labs(title = "Caloosahatchee River-West") + PlotTitle +
    rremove("ylab") + rremove("xlab") + theme(plot.margin = unit(c(0,0.5,0,0), "cm")),
  nrow = 2, heights = c(0.045, 0.05, 1.4))

annotate_figure(Sal_West_Fig, 
                left = text_grob("Salinity", rot = 90, vjust = 0.4, family = "serif", size = 16, color = "black"),
                bottom = text_grob("Date", family = "serif", size = 16, color = "black"))
```

```{r CERP Secchi Figure, fig.cap = "Figure 25. Monthly percent Secchi pentetration at stations within the five east coast study sites.", fig.height = 10, fig.width = 8, fig.fullwidth=TRUE}
SP_East_2 %>%
  ggplot(aes(RetDate, Secchi, fill = Station)) + 
  geom_col(position = position_dodge(13), width = 10, color = "black") + 
  facet_wrap(.~Site, nrow = 5, labeller = as_labeller(c("SLN" = "St. Lucie-North", "SLS" = "St. Lucie-South", "SLC" = "St. Lucie-Central", "LXN" = "Loxahatchee-North", "LXS" = "Loxahatchee-South"))) +
  scale_y_reverse("% Secchi Penetration", expand = c(0,0), limits = c(100, 0), breaks = seq(0, 100, by = 20)) +
  scale_x_date("Date", expand= c(0,0), date_breaks = "1 month", date_labels = "%b %Y", limits = c(End_date %m-% months(12) %m-% days(5), End_date %m-% days(5)))+
  Station_fill_E + BaseForm + FacetForm + East_legend
```

```{r CRE Seechi Figure, fig.cap = "Figure 26. Monthly percent Secchi penetration at stations within the two Caloosahatchee River study sites.", fig.height = 5, fig.width = 8, fig.fullwidth=TRUE}
SP_West_Fig <- ggarrange(
  SP_West %>% filter(Station == 1 | Station == 2) %>%
    ggplot(aes(RetDate, Secchi, fill = Station)) + 
    geom_col(position = position_dodge(15), width = 10, color = "black") +
    scale_y_reverse("% Secchi Penetration", expand = c(0,0), limits = c(100, 0), breaks = seq(0, 100, by = 20)) +
    scale_x_date("Date", expand= c(0,0), date_breaks = "1 month", date_labels = "%b %Y", limits = c(End_date %m-% months(12) %m-% days(5), End_date %m-% days(5)))+ 
    Station_fill_W + BaseForm + West_legend + 
    labs(title = "Caloosahatchee River-East") + PlotTitle +
    rremove("ylab") + rremove("xlab") + rremove("x.text") + theme(plot.margin = unit(c(0,0.5,0.5,0), "cm")), 
  SP_West %>% filter(Station == 3 | Station == 4) %>%
    ggplot(aes(RetDate, Secchi, fill = Station)) + 
    geom_col(position = position_dodge(15), width = 10, color = "black") +
    scale_y_reverse("% Secchi Penetration", expand = c(0,0), limits = c(100, 0), breaks = seq(0, 100, by = 20)) +
    scale_x_date("Date", expand= c(0,0), date_breaks = "1 month", date_labels = "%b %Y", limits = c(End_date %m-% months(12) %m-% days(5), End_date %m-% days(5)))+
    Station_fill_W + BaseForm + West_legend + 
    labs(title = "Caloosahatchee River-West") + PlotTitle +
    rremove("ylab") + rremove("xlab") + theme(plot.margin = unit(c(0,0.5,0,0), "cm")),
  nrow = 2, heights = c(0.045, 0.05, 1.4))

annotate_figure(SP_West_Fig, 
                left = text_grob("% Secchi Penetration", rot = 90, vjust = 0.4, family = "serif", size = 16, color = "black"),
                bottom = text_grob("Date", family = "serif", size = 16, color = "black"))
```