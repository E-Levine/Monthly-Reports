---
title: "Quarterly Report Information"
author: "ELevine"
date: "`r Sys.Date()`"
output: 
  html_document:
  word_document: NULL
params:
  Start_date: "2024-04-01"
  End_date: "2024-06-30"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
#Database <- "Oysters_24-10-17"  #Set the local database to use
#Server = "localhost\\ERICALOCALSQL" #Set the local Server to use
#
Start_date <- as.Date(params$Start_date)
End_date <- as.Date(params$End_date)

#Packages
if (!require("pacman")) {install.packages("pacman")}
#p_unlock()
pacman::p_load(odbc, DBI, dbplyr,
  tidyverse, dplyr,  stringr, #DF manipulation
  DT, openxlsx,         #Excel
  lubridate, zoo,         #Dates
  knitr, kableExtra, scales, gt, gtExtras,
  install = TRUE)
```

```{css}
p {
font-size: 12pt;
}

caption {
  color: black;
  font-weight: bold;
  font-size: 14;
  text-indent: 5%;
} 

h1 {
font-size: 21pt;
font-weight: bold;
}

h2 {
font-size: 17pt;
font-weight: bold;
}

h3 {
font-size: 13pt;
font-style: italic;
text-decoration: underline;
}
```

```{r Data gather from summary file}
WQ_Sal_s <-  readWorkbook("WQ_Summary_Data.xlsx", sheet = 'Salinity Station', detectDates = TRUE, check.names = TRUE)
WQ_Secchi_s <-  readWorkbook("WQ_Summary_Data.xlsx", sheet = 'Secchi Station', detectDates = TRUE, check.names = TRUE)
Dermo_df <- readWorkbook("Summary_Data.xlsx", sheet = 'Dermo Station', detectDates = TRUE, check.names = TRUE)
```

```{r Data selection and cleaning}
WQ_Sal_CERP <- WQ_Sal_s %>% dplyr::select(starts_with("SL"), starts_with("LX")) %>% subset(SL.C_RetDate_Sal > Start_date & SL.C_RetDate_Sal < End_date) %>% rename(RetDate = SL.C_RetDate_Sal) %>% dplyr::select(-SL.N_RetDate_Sal, -SL.S_RetDate_Sal, -LX.N_RetDate_Sal, -LX.S_RetDate_Sal) %>% mutate(RetDate = as.yearmon(RetDate))
WQ_Sal_CRE <- WQ_Sal_s %>% dplyr::select(starts_with("CR")) %>% subset(CR.E_RetDate_Sal > Start_date & CR.E_RetDate_Sal < End_date)  %>% rename(RetDate = CR.E_RetDate_Sal) %>% dplyr::select(-CR.W_RetDate_Sal)
WQ_Sal_PBC <- WQ_Sal_s %>% dplyr::select(starts_with("LW")) %>% subset(LW.L_RetDate_Sal > Start_date & LW.L_RetDate_Sal < End_date) %>% rename(RetDate = LW.L_RetDate_Sal) %>% dplyr::select(-LW.R_RetDate_Sal)
#
WQ_Sec_CERP <- WQ_Secchi_s %>% dplyr::select(starts_with("SL"), starts_with("LX")) %>% subset(SL.C_RetDate_SP > Start_date & SL.C_RetDate_SP < End_date) %>% rename(RetDate = SL.C_RetDate_SP) %>% dplyr::select(-SL.N_RetDate_SP, -SL.S_RetDate_SP, -LX.N_RetDate_SP, -LX.S_RetDate_SP) %>% mutate(RetDate = as.yearmon(RetDate))
WQ_Sec_CRE <- WQ_Secchi_s %>% dplyr::select(starts_with("CR")) %>% subset(CR.E_RetDate_SP > Start_date & CR.E_RetDate_SP < End_date)  %>% rename(RetDate = CR.E_RetDate_SP) %>% dplyr::select(-CR.W_RetDate_SP)
WQ_Sec_PBC <- WQ_Secchi_s %>% dplyr::select(starts_with("LW")) %>% subset(LW.L_RetDate_SP > Start_date & LW.L_RetDate_SP < End_date) %>% rename(RetDate = LW.L_RetDate_SP) %>% dplyr::select(-LW.R_RetDate_SP)
#
Dermo_CERP <- Dermo_df %>% dplyr::select(starts_with("SL"), starts_with("LX")) %>% dplyr::select(!contains("SD")) %>% subset(SL.C_RetDate > Start_date & SL.C_RetDate < End_date) %>% rename(RetDate = SL.C_RetDate) %>% dplyr::select(-SL.N_RetDate, -SL.S_RetDate, -LX.N_RetDate, -LX.S_RetDate) %>% mutate(RetDate = as.yearmon(RetDate))
Dermo_CRE <- Dermo_df %>% dplyr::select(starts_with("CR")) %>% dplyr::select(!contains("SD")) %>% subset(CR.E_RetDate > Start_date & CR.E_RetDate < End_date) %>% rename(RetDate = CR.E_RetDate) %>% dplyr::select(-CR.W_RetDate) %>% mutate(RetDate = as.yearmon(RetDate))
Dermo_PBC <- Dermo_df %>% dplyr::select(starts_with("LW")) %>% dplyr::select(!contains("SD")) %>% subset(LW.L_RetDate > Start_date & LW.L_RetDate < End_date) %>% rename(RetDate = LW.L_RetDate) %>% dplyr::select(-LW.R_RetDate) %>% mutate(RetDate = as.yearmon(RetDate))
```

```{r table formatting}
#Salinity
CERP_Sal <- WQ_Sal_CERP %>% gt() %>% data_color(columns = contains("Sal"), fn = scales::col_numeric(palette = "plasma", domain = WQ_Sal_CERP %>% dplyr::select(contains("Sal")) %>% unlist() %>% range())) %>% gt_add_divider(columns = c(1, 4, 7, 10, 13, 16), sides = "right", color = "black") %>% cols_label_with(fn = ~gsub("_Sal","", .)) %>% cols_align(align = c("center"), columns = everything())
CRE_Sal <- WQ_Sal_CRE %>% gt() %>% data_color(columns = contains("Sal"), fn = scales::col_numeric(palette = "plasma", domain = WQ_Sal_CRE %>% dplyr::select(contains("Sal")) %>% unlist() %>% range())) %>% gt_add_divider(columns = c(1, 3), sides = "right", color = "black") %>% cols_label_with(fn = ~gsub("_Sal","", .)) %>% cols_align(align = c("center"), columns = everything())
PBC_Sal <- WQ_Sal_PBC %>% gt() %>% data_color(columns = contains("Sal"), fn = scales::col_numeric(palette = "plasma", domain = WQ_Sal_PBC %>% dplyr::select(contains("Sal")) %>% unlist() %>% range())) %>% gt_add_divider(columns = c(1, 4), sides = "right", color = "black") %>% cols_label_with(fn = ~gsub("_Sal","", .)) %>% cols_align(align = c("center"), columns = everything())
#
##Secchi
CERP_Sec <- WQ_Sec_CERP %>% gt() %>% data_color(columns = contains("SP"), fn = scales::col_numeric(palette = "plasma", domain = WQ_Sec_CERP %>% dplyr::select(contains("SP")) %>% unlist() %>% range())) %>% gt_add_divider(columns = c(1, 4, 7, 10, 13, 16), sides = "right", color = "black") %>% cols_label_with(fn = ~gsub("_SP","", .)) %>% cols_align(align = c("center"), columns = everything())
CRE_Sec <- WQ_Sec_CRE %>% gt() %>% data_color(columns = contains("SP"), fn = scales::col_numeric(palette = "plasma", domain = WQ_Sec_CRE %>% dplyr::select(contains("SP")) %>% unlist() %>% range())) %>% gt_add_divider(columns = c(1, 3), sides = "right", color = "black") %>% cols_label_with(fn = ~gsub("_SP","", .)) %>% cols_align(align = c("center"), columns = everything())
PBC_Sec <- WQ_Sec_PBC %>% gt() %>% data_color(columns = contains("SP"), fn = scales::col_numeric(palette = "plasma", domain = WQ_Sec_PBC %>% dplyr::select(contains("SP")) %>% unlist() %>% range())) %>% gt_add_divider(columns = c(1, 4), sides = "right", color = "black") %>% cols_label_with(fn = ~gsub("_SP","", .)) %>% cols_align(align = c("center"), columns = everything())
#
##Dermo
CERP_dermo <- Dermo_CERP %>% gt() %>% data_color(columns = contains("Pct"), fn = scales::col_numeric(palette = "plasma", domain = Dermo_CERP %>% dplyr::select(contains("Pct")) %>% unlist() %>% range())) %>% cols_label_with(fn = ~gsub("_Mean","", .)) %>% cols_label_with(fn = ~gsub("_Pct","", .)) %>% gt_add_divider(columns = c(1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21, 23, 25, 27, 29), sides = "right", color = "black") %>% cols_align(align = c("center"), columns = everything()) %>% tab_options(container.width = 1500)
CRE_dermo <- Dermo_CRE %>% gt() %>% data_color(columns = contains("Pct"), fn = scales::col_numeric(palette = "plasma", domain = Dermo_CRE %>% dplyr::select(contains("Pct")) %>% unlist() %>% range())) %>% cols_label_with(fn = ~gsub("_Mean","", .)) %>% cols_label_with(fn = ~gsub("_Pct","", .)) %>% gt_add_divider(columns = c(1, 3, 5, 7), sides = "right", color = "black") %>% cols_align(align = c("center"), columns = everything())
PBC_dermo <- Dermo_PBC %>% gt() %>% data_color(columns = contains("Pct"), fn = scales::col_numeric(palette = "plasma", domain = Dermo_PBC %>% dplyr::select(contains("Pct")) %>% unlist() %>% range())) %>% cols_label_with(fn = ~gsub("_Mean","", .)) %>% cols_label_with(fn = ~gsub("_Pct","", .)) %>% gt_add_divider(columns = c(1, 3, 5, 7), sides = "right", color = "black") %>% cols_align(align = c("center"), columns = everything())
#

```
## Report summary
This data summary was compiled on `r format(Sys.Date(), "%d %B %Y")` and summarizes data for **CERP** and **PBC** quarterly reports from `r format(Start_date, "%B %Y")` through `r format(End_date, "%B %Y")` .\

<h1>`r paste("CERP Quarterly Report")`</h1>
<h2>`r paste("East Coast")`</h2>
<h3> `r paste("Water Quality summary")` </h3>
Minimum and maximum values observed during the quarter and data ordered by increasing values.
`r CERP_Sal %>% tab_caption(caption = "Monthly CERP salinity measurements")`
`r CERP_Sec %>% tab_caption(caption = "Monthly CERP secchi measurements")`
<h3> `r paste("Dermo summary")` </h3>
`r CERP_dermo %>% tab_caption(caption = "Monthly CERP dermo intensity and prevelence")`
<p> Intensity range: `r Dermo_CERP %>% dplyr::select(contains("Mean")) %>% unlist() %>% min()` - `r Dermo_CERP %>% dplyr::select(contains("Mean")) %>% unlist() %>% max()`\
Prevalence range: `r Dermo_CERP %>% dplyr::select(contains("Pct")) %>% unlist() %>% min()` - `r Dermo_CERP %>% dplyr::select(contains("Pct")) %>% unlist() %>% max()` </p>

<h2>`r paste("West Coast")`</h2>
<h3> `r paste("Water Quality summary")` </h3>
Minimum and maximum values observed during the quarter and data ordered by increasing values.
`r CRE_Sal %>% tab_caption(caption = "Monthly CRE salinity measurements")`
`r CRE_Sec %>% tab_caption(caption = "Monthly CRE secchi measurements")`
<h3> `r paste("Dermo summary")` </h3>
`r CRE_dermo %>% tab_caption(caption = "Monthly CRE dermo intensity and prevelence")`
<p> Intensity range: `r Dermo_CRE %>% dplyr::select(contains("Mean")) %>% unlist() %>% min()` - `r Dermo_CRE %>% dplyr::select(contains("Mean")) %>% unlist() %>% max()`\
Prevalence range: `r Dermo_CRE %>% dplyr::select(contains("Pct")) %>% unlist() %>% min()` - `r Dermo_CRE %>% dplyr::select(contains("Pct")) %>% unlist() %>% max()` </p>

<h1>`r paste("PBC Quarterly Report")`</h1>
<h3> `r paste("Water Quality summary")` </h3>
Minimum and maximum values observed during the quarter and data ordered by increasing values.
`r PBC_Sal %>% tab_caption(caption = "Monthly PBC salinity measurements")`
`r PBC_Sec %>% tab_caption(caption = "Monthly PBC secchi measurements")`
<h3> `r paste("Dermo summary")` </h3>
`r PBC_dermo %>% tab_caption(caption = "Monthly PBC dermo intensity and prevelence")`
<p> Intensity range: `r Dermo_PBC %>% dplyr::select(contains("Mean")) %>% unlist() %>% min()` - `r Dermo_PBC %>% dplyr::select(contains("Mean")) %>% unlist() %>% max()`\
Prevalence range: `r Dermo_PBC %>% dplyr::select(contains("Pct")) %>% unlist() %>% min()` - `r Dermo_PBC %>% dplyr::select(contains("Pct")) %>% unlist() %>% max()` </p>